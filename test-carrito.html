<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Carrito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="css/carrito-moderno.css">
    <link rel="stylesheet" href="css/progress-steps-enhanced.css">
</head>

<body>
    <div class="p-8">
        <h1 class="text-2xl font-bold mb-4">Test de Pasos del Carrito</h1>

        <!-- Progress Steps - Ultra Minimalista -->
        <div class="progress-container">
            <div class="progress-step active" data-step="1">
                <div class="step-circle">1</div>
                <span class="step-label">Carrito</span>
                <div class="progress-line"></div>
            </div>

            <div class="progress-step" data-step="2">
                <div class="step-circle">2</div>
                <span class="step-label">Envío</span>
                <div class="progress-line"></div>
            </div>

            <div class="progress-step" data-step="3">
                <div class="step-circle">3</div>
                <span class="step-label">PDF</span>
            </div>
        </div>

        <!-- Los ahorros por promociones ahora se integran en la línea de descuento -->

        <!-- Contenedor para mostrar productos del carrito -->
        <div class="max-w-4xl mx-auto mt-8">
            <div id="cart-items-container" class="space-y-4">
                <!-- Los productos aparecerán aquí -->
            </div>
            <div id="empty-cart-message" class="text-center py-8 text-gray-500">
                El carrito está vacío
            </div>
        </div>

        <div class="flex gap-4 mt-8 flex-wrap">
            <button onclick="testSteps()"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                Test Cambiar Pasos
            </button>
            <button onclick="testPDF()"
                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                Test Generar PDF
            </button>
            <button onclick="testPromotions()"
                class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition-colors">
                Test Promociones
            </button>
            <button onclick="testAddProduct()"
                class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition-colors">
                Agregar Vela Jack
            </button>
            <button onclick="addDifferentProduct()"
                class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition-colors">
                Agregar Vela Rosa
            </button>
            <button onclick="clearCart()"
                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors">
                Limpiar Carrito
            </button>
        </div>
    </div>

    <script>
        function testSteps() {
            const steps = document.querySelectorAll('.progress-step');
            steps.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index === 1) {
                    step.classList.add('active');
                } else if (index === 0) {
                    step.classList.add('completed');
                }
            });
        }

        function testPDF() {
            // Simular datos de prueba
            const mockCart = {
                cart: [
                    {
                        id: 1,
                        title: 'Vela Jack Calabaza',
                        price: 80,
                        quantity: 2,
                        promotion2x1: true,
                        image: 'images/vela-jack.png'
                    }
                ],
                calculateOriginalSubtotal: () => 160,
                calculateSubtotal: () => 80,
                calculateDiscount: () => 0,
                calculateShipping: () => 120,
                getShippingFormData: () => ({
                    fullName: 'Juan Pérez',
                    phone: '5555555555',
                    email: 'juan@email.com',
                    address: 'Calle Ejemplo 123',
                    city: 'Ciudad de México',
                    state: 'CDMX',
                    postalCode: '12345'
                }),
                showToast: (msg, type) => console.log(`Toast: ${msg} (${type})`),
                showLoading: (show) => console.log(`Loading: ${show}`)
            };

            // Crear instancia temporal para prueba
            const testInstance = Object.assign(Object.create(ModernCart.prototype), mockCart);
            testInstance.generateActualPDF();
        }

        // Array para almacenar productos del carrito
        let cartItems = [];

        function testAddProduct() {
            const container = document.getElementById('cart-items-container');
            const emptyMessage = document.getElementById('empty-cart-message');

            // Crear nuevo producto
            const newProduct = {
                id: Date.now(),
                title: 'Vela Jack Calabaza',
                price: 80,
                quantity: 1,
                image: 'https://via.placeholder.com/80x80/2D3E33/FFFFFF?text=Vela',
                fragrance: 'Canela y Naranja',
                color: 'Naranja',
                size: 'Mediana',
                promotion2x1: true
            };

            // Agregar al array
            cartItems.push(newProduct);

            // Ocultar mensaje vacío
            if (emptyMessage) emptyMessage.style.display = 'none';

            // Renderizar todos los productos
            renderCartItems();

            console.log('Producto agregado:', newProduct);
            console.log('Total productos:', cartItems.length);
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            if (!container) return;

            container.innerHTML = cartItems.map((item, index) => {
                let originalPrice = item.price * item.quantity;
                let finalPrice = originalPrice;
                let savings = 0;
                let promotionText = '';

                // Aplicar promoción 2x1
                if (item.promotion2x1) {
                    finalPrice = item.price * Math.ceil(item.quantity / 2);
                    savings = originalPrice - finalPrice;
                    promotionText = `
                        <div class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mt-2">
                            <i class="fas fa-gift"></i> 2x1 - Ahorras $${savings.toFixed(2)}
                        </div>
                    `;
                }

                // Aplicar descuento especial
                if (item.specialDiscount && item.specialDiscount.percentage > 0) {
                    const discount = finalPrice * (item.specialDiscount.percentage / 100);
                    finalPrice -= discount;
                    savings += discount;
                    promotionText += `
                        <div class="inline-block bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full mt-2 ml-2">
                            <i class="fas fa-percent"></i> ${item.specialDiscount.percentage}% OFF - Ahorras $${discount.toFixed(2)}
                        </div>
                    `;
                }

                return `
                    <div class="bg-white rounded-lg shadow-md p-4 flex items-center gap-4 border border-gray-200">
                        <img src="${item.image}" alt="${item.title}" class="w-20 h-20 rounded-lg object-cover">
                        
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 text-lg">${item.title}</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                <div><i class="fas fa-leaf text-green-600"></i> ${item.fragrance}</div>
                                <div><i class="fas fa-palette text-blue-600"></i> ${item.color}</div>
                                <div><i class="fas fa-ruler text-purple-600"></i> ${item.size}</div>
                            </div>
                            ${promotionText}
                        </div>

                        <div class="flex items-center gap-3 bg-gray-50 rounded-lg px-3 py-2">
                            <button onclick="changeQuantity(${index}, -1)" class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="font-semibold text-lg min-w-[2rem] text-center">${item.quantity}</span>
                            <button onclick="changeQuantity(${index}, 1)" class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center hover:bg-green-600 transition-colors">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>

                        <div class="text-right">
                            <div class="font-bold text-lg text-gray-800">$${finalPrice.toFixed(2)}</div>
                            <div class="text-sm text-gray-500">$${item.price.toFixed(2)} c/u</div>
                            ${savings > 0 ? `
                                <div class="text-xs text-gray-400 line-through">
                                    Original: $${originalPrice.toFixed(2)}
                                </div>
                            ` : ''}
                        </div>

                        <button onclick="removeProduct(${index})" class="w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors" title="Eliminar producto">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function changeQuantity(index, change) {
            if (cartItems[index]) {
                cartItems[index].quantity += change;
                if (cartItems[index].quantity <= 0) {
                    removeProduct(index);
                } else {
                    renderCartItems();
                }
            }
        }

        function removeProduct(index) {
            cartItems.splice(index, 1);
            renderCartItems();

            // Mostrar mensaje vacío si no hay productos
            if (cartItems.length === 0) {
                const emptyMessage = document.getElementById('empty-cart-message');
                if (emptyMessage) emptyMessage.style.display = 'block';
            }

            console.log('Producto eliminado. Total productos:', cartItems.length);
        }

        function addDifferentProduct() {
            const container = document.getElementById('cart-items-container');
            const emptyMessage = document.getElementById('empty-cart-message');

            // Crear producto diferente
            const newProduct = {
                id: Date.now(),
                title: 'Vela Rosa Romántica',
                price: 120,
                quantity: 1,
                image: 'https://via.placeholder.com/80x80/FF69B4/FFFFFF?text=Rosa',
                fragrance: 'Rosas y Vainilla',
                color: 'Rosa',
                size: 'Grande',
                promotion2x1: false,
                specialDiscount: { percentage: 15 }
            };

            // Agregar al array
            cartItems.push(newProduct);

            // Ocultar mensaje vacío
            if (emptyMessage) emptyMessage.style.display = 'none';

            // Renderizar todos los productos
            renderCartItems();

            console.log('Producto Rosa agregado:', newProduct);
            console.log('Total productos:', cartItems.length);
        }

        function testPromotions() {
            // Simular ahorros por promociones
            const savings = 61.50;

            // Crear contenedor de prueba si no existe
            let testContainer = document.getElementById('test-summary');
            if (!testContainer) {
                testContainer = document.createElement('div');
                testContainer.id = 'test-summary';
                testContainer.className = 'summary-content max-w-md mx-auto mt-4 p-4 bg-white rounded-lg shadow';
                testContainer.innerHTML = `
                    <div class="summary-line">
                        <span>Subtotal:</span>
                        <span id="subtotal">200.00 MXN</span>
                    </div>
                    <div class="summary-line">
                        <span>Envío:</span>
                        <span id="shipping">120.00 MXN</span>
                    </div>
                    <div class="summary-line">
                        <span>Descuento:</span>
                        <span id="discount">-61.50 MXN</span>
                    </div>
                    <div class="summary-line">
                        <span>Total:</span>
                        <span id="total">258.50 MXN</span>
                    </div>
                `;
                document.body.appendChild(testContainer);
            }

            // Aplicar función de promociones mejorada
            if (window.modernCart && window.modernCart.updatePromotionSavingsImproved) {
                window.modernCart.updatePromotionSavingsImproved(savings);
            } else {
                // Fallback para mostrar el concepto
                const discountElement = document.querySelector('#discount');
                if (discountElement && discountElement.parentNode) {
                    const discountLabel = discountElement.parentNode.querySelector('span:first-child');
                    if (discountLabel) {
                        discountLabel.innerHTML = `
                            Descuento:
                            <span class="text-xs text-green-600 block">
                                (Incluye ${savings.toFixed(2)} MXN en promociones)
                            </span>
                        `;
                    }
                }
            }
        }

        function clearCart() {
            cartItems = [];
            const container = document.getElementById('cart-items-container');
            const emptyMessage = document.getElementById('empty-cart-message');

            if (container) {
                container.innerHTML = '';
                if (emptyMessage) emptyMessage.style.display = 'block';
                console.log('Carrito limpiado');
            }

            if (window.modernCart) {
                window.modernCart.clearCart();
            }
        }
    </script>
    <script src="js/carrito-moderno.js"></script>
</body>

</html>